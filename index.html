<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kalender & To-Dos (Offline)</title>
  <meta name="description" content="Offlinefähige Kalender- und To-Do-App. Vanilla HTML/CSS/JS. LocalStorage only." />

  <!-- ---------- STYLES ---------- -->
  <style>
    :root{
      --bg:black;
      --fg:white;
      --muted:#d0d0d0;
      --muted2:#a8a8a8;
      --line:#444;
      --pill-bg:#fff;
      --pill-fg:#000;
      --hover:rgba(255,255,255,0.08);
      --radius:8px;
      --gap:12px;
      --gap-sm:8px;
      --gap-lg:16px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      --border:1px solid var(--line);
      --focus:0 0 0 2px #fff inset;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family:var(--font);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    a{ color:var(--fg); }
    button, input, select, textarea{
      color:var(--fg);
      background:transparent;
      border:var(--border);
      border-radius:var(--radius);
      padding:8px 10px;
      font:inherit;
    }
    button:hover, .btn:hover, .tab:hover, .tool:hover{ background:var(--hover); }
    button:focus, input:focus, select:focus, textarea:focus, .focusable:focus{ outline:none; box-shadow:var(--focus); }
    .btn, .tool{
      display:inline-flex; align-items:center; justify-content:center;
      gap:6px; padding:8px 12px; border:var(--border); border-radius:var(--radius);
      cursor:pointer; user-select:none;
    }
    .toolbar{ display:flex; gap:var(--gap-sm); align-items:center; flex-wrap:wrap; }
    .row{ display:flex; gap:var(--gap); align-items:center; }
    .grow{ flex:1; }
    .muted{ color:var(--muted2); }
    .hidden{ display:none !important; }

    /* Layout */
    .app{
      display:grid;
      grid-template-columns: 1fr 360px;
      grid-template-rows: auto 1fr;
      grid-template-areas:
        "header header"
        "main sidebar";
      height:100vh;
      gap:var(--gap);
      padding:var(--gap);
    }
    header{
      grid-area:header;
      display:flex; align-items:center; justify-content:space-between; gap:var(--gap);
      padding:var(--gap); border:var(--border); border-radius:var(--radius);
    }
    main{
      grid-area:main;
      display:flex; flex-direction:column; gap:var(--gap);
      min-width:0;
    }
    aside{
      grid-area:sidebar;
      display:flex; flex-direction:column; gap:var(--gap);
      min-width:0;
    }
    .panel{
      border:var(--border); border-radius:var(--radius); padding:var(--gap);
      min-height:0; background:transparent;
    }

    /* Tabs (mobile) */
    .tabs{
      display:none;
      gap:var(--gap-sm);
    }
    .tab{
      flex:1; text-align:center; padding:10px; border:var(--border); border-radius:var(--radius);
      cursor:pointer;
    }
    .tab.active{ outline:2px solid #fff; }

    /* Calendar header */
    .cal-head{ display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap; }
    .view-switch{ display:flex; gap:var(--gap-sm); }

    /* Calendar grids */
    .cal{
      border:var(--border); border-radius:var(--radius);
      overflow:hidden; display:flex; flex-direction:column; min-height:0; background:transparent;
    }
    .cal-weekdays, .cal-timebar{
      display:grid; grid-template-columns: repeat(7, 1fr);
      border-bottom:var(--border);
    }
    .cal-weekdays > div, .cal-day-header{
      padding:8px; border-right:var(--border);
    }
    .cal-weekdays > div:last-child{ border-right:none; }
    .cal-month{
      flex:1; display:grid; grid-template-columns: repeat(7, 1fr); grid-auto-rows: minmax(100px, 1fr);
    }
    .cell{
      border-right:var(--border); border-bottom:var(--border); padding:6px; position:relative; min-height:100px;
      overflow:hidden;
    }
    .cell:nth-child(7n){ border-right:none; }
    .day-num{ font-size:12px; color:var(--muted); }
    .event-pill{
      display:inline-flex; align-items:center; gap:6px;
      background:var(--pill-bg); color:var(--pill-fg); border-radius:999px; padding:2px 8px;
      font-size:12px; margin-top:4px; cursor:grab; user-select:none; border:0;
    }
    .event-pill:active{ cursor:grabbing; }
    .drop-target{ outline:2px dashed #fff; outline-offset:-4px; }

    /* Week/Day time grid */
    .time-grid{
      display:grid; grid-template-columns: 64px 1fr; min-height:0; flex:1; overflow:auto; border-top:var(--border);
    }
    .timebar{ border-right:var(--border); }
    .timebar .hour{ height:48px; border-bottom:var(--border); padding:4px; font-size:12px; color:var(--muted); }
    .days-container{ display:grid; grid-template-columns: repeat(var(--cols,7), 1fr); }
    .day-col{ position:relative; border-right:var(--border); min-height: calc(24*48px); }
    .day-col:last-child{ border-right:none; }
    .slot{ height:24px; border-bottom:1px dotted var(--line); }
    .event-block{
      position:absolute; left:6px; right:6px;
      background:var(--pill-bg); color:var(--pill-fg); border-radius:var(--radius);
      padding:6px 8px; font-size:12px; cursor:grab; user-select:none;
      border:0;
    }

    /* Tasks */
    .lists-head{ display:flex; gap:var(--gap-sm); align-items:center; }
    .lists{ display:flex; gap:var(--gap-sm); flex-wrap:wrap; }
    .chip{
      border:var(--border); border-radius:999px; padding:6px 10px; cursor:pointer;
    }
    .chip.active{ outline:2px solid #fff; }
    .task-search{ width:100%; }
    .task-list{ display:flex; flex-direction:column; gap:8px; overflow:auto; min-height:0; }
    .task{
      border:var(--border); border-radius:var(--radius); padding:8px; display:flex; gap:8px; align-items:flex-start;
      background:transparent;
    }
    .task[draggable="true"]{ cursor:grab; }
    .task-title{ font-weight:600; }
    .subtasks{ margin-left:26px; display:flex; flex-direction:column; gap:6px; margin-top:6px; }
    .task-meta{ font-size:12px; color:var(--muted); }

    /* Modals */
    dialog{
      border:var(--border); border-radius:var(--radius); color:var(--fg); background:var(--bg);
      padding:16px; width:min(640px, 96vw);
    }
    dialog::backdrop{ background:rgba(0,0,0,0.6); }
    .modal-head{ display:flex; justify-content:space-between; align-items:center; gap:var(--gap); margin-bottom:12px; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); }
    .grid-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:var(--gap); }
    .stack{ display:flex; flex-direction:column; gap:var(--gap-sm); }
    .right{ display:flex; gap:var(--gap-sm); align-items:center; }
    .danger{ border-color:#777; }
    .toolbar-wrap{ display:flex; gap:var(--gap-sm); flex-wrap:wrap; align-items:center; }

    /* Responsive */
    @media (max-width: 900px){
      .app{
        grid-template-columns: 1fr;
        grid-template-areas:
          "header"
          "main";
      }
      aside{ display:none; }
      .tabs{ display:flex; }
      .mobile-pane{ display:none; }
      .mobile-pane.active{ display:block; }
    }
  </style>
</head>
<body>
  <div class="app" aria-label="Kalender und Aufgaben App">
    <header>
      <div class="toolbar-wrap" role="toolbar" aria-label="Navigation">
        <button class="tool" id="btn-today" title="Gehe zu Heute (D)">Heute</button>
        <div class="row">
          <button class="tool" id="btn-prev" aria-label="Vorheriger Zeitraum">‹</button>
          <div id="title" aria-live="polite"></div>
          <button class="tool" id="btn-next" aria-label="Nächster Zeitraum">›</button>
        </div>
        <div class="view-switch" role="tablist" aria-label="Ansicht wählen">
          <button class="tool" data-view="month" role="tab" aria-selected="true">Monat</button>
          <button class="tool" data-view="week" role="tab">Woche</button>
          <button class="tool" data-view="day" role="tab">Tag</button>
        </div>
      </div>
      <div class="toolbar">
        <button class="btn" id="btn-new-event" title="Neuer Termin (N)">+ Termin</button>
        <button class="btn" id="btn-new-task" title="Neue Aufgabe (T)">+ Aufgabe</button>
        <button class="btn" id="btn-notify">Benachrichtigungen</button>
        <button class="btn" id="btn-export">Export</button>
        <label class="btn" for="file-import" aria-label="JSON Import">Import<input id="file-import" type="file" accept="application/json" class="hidden" /></label>
      </div>
    </header>

    <main>
      <div class="tabs" aria-label="Bereich auswählen (mobil)">
        <button class="tab active" data-tab="calendar" aria-selected="true">Kalender</button>
        <button class="tab" data-tab="tasks" aria-selected="false">Aufgaben</button>
      </div>

      <section id="calendar-pane" class="mobile-pane active" aria-label="Kalender">
        <div class="panel cal-head">
          <div class="muted">Ziehe Aufgaben in den Kalender um Zeitblöcke zu erstellen.</div>
          <div class="grow"></div>
          <div class="muted">Shortcuts: <kbd>N</kbd> Termin, <kbd>T</kbd> Aufgabe, <kbd>D</kbd> Heute</div>
        </div>

        <div class="cal panel" id="calendar" aria-label="Kalenderanzeige">
          <!-- dynamisch gefüllt -->
        </div>
      </section>

      <section id="tasks-pane" class="mobile-pane active" aria-label="Aufgaben" style="display:none">
        <div class="panel" id="tasks-panel">
          <div class="lists-head">
            <input id="task-search" class="task-search" type="search" placeholder="Suchen…" aria-label="Aufgaben durchsuchen" />
            <button class="btn" id="btn-new-list">+ Liste</button>
            <div class="muted">Filter:</div>
            <select id="task-filter" aria-label="Filter">
              <option value="all">Alle</option>
              <option value="today">Heute</option>
              <option value="overdue">Überfällig</option>
              <option value="scheduled">Geplant</option>
              <option value="repeat">Wiederkehrend</option>
            </select>
          </div>
          <div class="lists" id="lists" role="tablist" aria-label="Aufgabenlisten"></div>
          <div class="task-list" id="task-list" aria-live="polite"></div>
        </div>
      </section>
    </main>

    <aside aria-label="Aufgaben (Desktop)">
      <div class="panel" id="sidebar-tasks">
        <div class="lists-head">
          <div class="muted">Aufgaben</div>
          <div class="grow"></div>
          <button class="btn" id="btn-add-task">+ Aufgabe</button>
        </div>
        <div class="lists" id="lists-side"></div>
        <input id="task-search-side" class="task-search" type="search" placeholder="Suchen…" aria-label="Aufgaben durchsuchen" />
        <div class="task-list" id="task-list-side" aria-live="polite"></div>
      </div>
    </aside>
  </div>

  <!-- Event Modal -->
  <dialog id="event-modal" aria-label="Termin bearbeiten">
    <form method="dialog" id="event-form" class="stack">
      <div class="modal-head">
        <strong>Termin</strong>
        <div class="right">
          <button class="btn danger" type="button" id="event-delete">Löschen</button>
          <button class="btn" value="cancel">Abbrechen</button>
          <button class="btn" value="save">Speichern</button>
        </div>
      </div>
      <input type="hidden" id="event-id" />
      <label class="stack">
        <span>Titel</span>
        <input id="event-title" required aria-required="true" />
      </label>
      <div class="grid-3">
        <label class="stack"><span>Datum</span><input type="date" id="event-date" required /></label>
        <label class="stack"><span>Start</span><input type="time" id="event-start" /></label>
        <label class="stack"><span>Ende</span><input type="time" id="event-end" /></label>
      </div>
      <label class="row">
        <input type="checkbox" id="event-allDay" /> <span>Ganztägig</span>
      </label>
      <label class="stack"><span>Ort</span><input id="event-location" /></label>
      <label class="stack"><span>Beschreibung</span><textarea id="event-desc" rows="3"></textarea></label>

      <fieldset class="stack" style="border:none; padding:0;">
        <legend class="muted">Wiederholen</legend>
        <div class="grid-3">
          <label class="stack">
            <span>Frequenz</span>
            <select id="event-rrule-freq">
              <option value="">Keine</option>
              <option value="daily">Täglich</option>
              <option value="weekly">Wöchentlich</option>
              <option value="monthly">Monatlich</option>
              <option value="yearly">Jährlich</option>
            </select>
          </label>
          <label class="stack"><span>Enddatum</span><input type="date" id="event-rrule-until" /></label>
          <div></div>
        </div>
      </fieldset>
    </form>
  </dialog>

  <!-- Task Modal -->
  <dialog id="task-modal" aria-label="Aufgabe bearbeiten">
    <form method="dialog" id="task-form" class="stack">
      <div class="modal-head">
        <strong>Aufgabe</strong>
        <div class="right">
          <button class="btn danger" type="button" id="task-delete">Löschen</button>
          <button class="btn" value="cancel">Abbrechen</button>
          <button class="btn" value="save">Speichern</button>
        </div>
      </div>
      <input type="hidden" id="task-id" />
      <label class="stack">
        <span>Titel</span>
        <input id="task-title" required aria-required="true" />
      </label>
      <label class="stack">
        <span>Liste</span>
        <input id="task-list-name" list="datalist-lists" placeholder="z. B. Inbox" />
        <datalist id="datalist-lists"></datalist>
      </label>
      <div class="grid-3">
        <label class="stack"><span>Datum</span><input type="date" id="task-date" /></label>
        <label class="stack"><span>Wiederholen</span>
          <select id="task-rrule-freq">
            <option value="">Keine</option>
            <option value="daily">Täglich</option>
            <option value="weekly">Wöchentlich</option>
            <option value="monthly">Monatlich</option>
            <option value="yearly">Jährlich</option>
          </select>
        </label>
        <label class="stack"><span>Bis</span><input type="date" id="task-rrule-until" /></label>
      </div>
      <label class="stack"><span>Beschreibung</span><textarea id="task-desc" rows="3"></textarea></label>
      <div class="stack">
        <span>Subtasks (eine pro Zeile)</span>
        <textarea id="task-subtasks" rows="4" placeholder="- Unteraufgabe A&#10;- Unteraufgabe B"></textarea>
      </div>
    </form>
  </dialog>

  <!-- ---------- SCRIPT ---------- -->
  <script>
  /***********************
   * Utilities & Dates
   ***********************/
  const KEY = 'calendarTodoApp_v1';
  const todayISO = () => new Date().toISOString().slice(0,10);
  const toISODate = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString().slice(0,10);
  const parseDate = (iso) => { const [y,m,da]=iso.split('-').map(Number); return new Date(y, m-1, da); };
  const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
  const sameDay = (a,b)=>a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  const clampTime = (t)=> t && /^\d{2}:\d{2}$/.test(t) ? t : '';
  const uid = ()=> Math.random().toString(36).slice(2,10);

  const fmtDate = (d, opts={}) => new Intl.DateTimeFormat('de-DE', {weekday:opts.weekday?'long':undefined, day:'2-digit', month:'long', year:'numeric'}).format(d);
  const fmtMonthTitle = (y,m)=> new Intl.DateTimeFormat('de-DE', {month:'long', year:'numeric'}).format(new Date(y,m,1));
  const fmtWeekTitle = (start)=> {
    const end = addDays(start,6);
    return `${fmtDate(start)} – ${fmtDate(end)}`;
  };
  const weekdaysShort = ['Mo','Di','Mi','Do','Fr','Sa','So'];
  const startOfWeek = (d)=> {
    const x = new Date(d); // Monday as start
    const day = (x.getDay()+6)%7;
    x.setDate(x.getDate()-day);
    x.setHours(0,0,0,0);
    return x;
  };

  /***********************
   * State & Storage
   ***********************/
  const defaultState = () => ({
    version: 1,
    settings: { notifications: false },
    cursor: toISODate(new Date()),
    view: 'month',
    lists: [{id:'inbox', name:'Inbox'}],
    tasks: [],
    events: [],
  });

  function migrateState(s){
    if(!s) return defaultState();
    // example future migrations:
    if(!s.version){ s.version = 1; }
    if(!s.settings) s.settings = { notifications:false };
    if(!s.lists || !Array.isArray(s.lists) || !s.lists.length) s.lists = [{id:'inbox', name:'Inbox'}];
    if(!s.view) s.view = 'month';
    if(!s.cursor) s.cursor = toISODate(new Date());
    if(!s.tasks) s.tasks = [];
    if(!s.events) s.events = [];
    return s;
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(KEY);
      return migrateState(raw ? JSON.parse(raw) : null);
    }catch(e){
      console.error('loadState failed', e);
      return defaultState();
    }
  }
  function saveState(){
    localStorage.setItem(KEY, JSON.stringify(state));
    render(); // keep UI synced
  }

  let state = loadState();

  /***********************
   * Recurrence expansion
   ***********************/
  function* expandRecurrence(item, rangeStart, rangeEnd){
    // item: {date:'YYYY-MM-DD', rrule:{freq, until}}
    const base = parseDate(item.date);
    const until = item.rrule?.until ? parseDate(item.rrule.until) : null;
    const freq = item.rrule?.freq || '';
    let cur = new Date(base);
    const inc = {
      'daily': d=>{ d.setDate(d.getDate()+1); },
      'weekly': d=>{ d.setDate(d.getDate()+7); },
      'monthly': d=>{ d.setMonth(d.getMonth()+1); },
      'yearly': d=>{ d.setFullYear(d.getFullYear()+1); },
    }[freq];
    if(!inc){
      // Non-recurring: yield if in range
      if(cur>=rangeStart && cur<=rangeEnd) yield toISODate(cur);
      return;
    }
    // Walk occurrences; stop at until or rangeEnd, whichever first
    while(true){
      const curISO = toISODate(cur);
      const inRange = cur >= rangeStart && cur <= rangeEnd;
      if(inRange) yield curISO;
      inc(cur);
      if(until && cur > until) break;
      if(cur > rangeEnd) break;
    }
  }

  /***********************
   * Notifications
   ***********************/
  function ensureNotifications(){
    if(Notification && Notification.permission === 'granted'){
      state.settings.notifications = true; saveState();
      return;
    }
    Notification.requestPermission().then(p=>{
      state.settings.notifications = (p==='granted'); saveState();
    });
  }
  function notify(title, body){
    if(!state.settings.notifications || !('Notification' in window)) return;
    try{ new Notification(title, {body}); }catch{}
  }
  // lightweight scheduler: checks minute-wise upcoming events
  setInterval(()=>{
    const now = new Date();
    const soon = new Date(now.getTime()+60*1000);
    for(const ev of state.events){
      const evDate = parseDate(ev.date);
      if(ev.allDay) continue;
      if(!ev.start) continue;
      const [hh,mm] = ev.start.split(':').map(Number);
      evDate.setHours(hh,mm,0,0);
      if(evDate>=now && evDate<=soon){
        notify('Termin beginnt bald', ev.title || 'Termin');
      }
    }
  }, 30000);

  /***********************
   * Calendar Rendering
   ***********************/
  const calendarEl = document.getElementById('calendar');
  const titleEl = document.getElementById('title');

  function render(){
    renderLists();
    renderTasks();
    renderCalendar();
    updateTitle();
    fillDatalists();
  }

  function updateTitle(){
    const cur = parseDate(state.cursor);
    if(state.view==='month') titleEl.textContent = fmtMonthTitle(cur.getFullYear(), cur.getMonth());
    else if(state.view==='week') titleEl.textContent = fmtWeekTitle(startOfWeek(cur));
    else titleEl.textContent = fmtDate(cur, {weekday:true});
  }

  // Month view
  function buildMonth(){
    const cur = parseDate(state.cursor);
    const y = cur.getFullYear(), m = cur.getMonth();
    const first = new Date(y,m,1);
    const start = startOfWeek(first);
    const grid = document.createElement('div');
    grid.className='cal-month';
    const weekdays = document.createElement('div');
    weekdays.className='cal-weekdays';
    weekdays.setAttribute('role','row');
    weekdays.innerHTML = weekdaysShort.map(w=>`<div role="columnheader" aria-label="${w}">${w}</div>`).join('');
    calendarEl.innerHTML='';
    calendarEl.appendChild(weekdays);
    // figure range end ~ 6 weeks
    const end = addDays(start, 6*7-1);
    const evs = eventsInRange(start, end);
    for(let i=0;i<42;i++){
      const day = addDays(start, i);
      const dayISO = toISODate(day);
      const cell = document.createElement('div');
      cell.className='cell';
      cell.setAttribute('role','gridcell');
      cell.dataset.date = dayISO;
      cell.tabIndex=0;
      cell.ondblclick = ()=> openEventModal({date:dayISO, allDay:true});
      enableDrop(cell);
      const dn = document.createElement('div');
      dn.className='day-num';
      dn.textContent = day.getDate();
      if(day.getMonth()!==m) dn.style.opacity='0.4';
      cell.appendChild(dn);
      // events
      const dayEvents = evs.filter(e=>e.date===dayISO);
      for(const e of dayEvents.slice(0,10)){
        const pill = document.createElement('button');
        pill.className='event-pill';
        pill.textContent = e.allDay ? e.title : `${e.start||''} ${e.title}`;
        pill.draggable = true;
        pill.ariaLabel = `Termin: ${e.title}`;
        pill.addEventListener('click', ()=> openEventModal(e));
        enableEventDrag(pill, e);
        cell.appendChild(pill);
      }
      grid.appendChild(cell);
    }
    calendarEl.appendChild(grid);
  }

  // Week/Day view
  function buildTimeGrid(days){
    calendarEl.innerHTML='';
    const weekdays = document.createElement('div');
    weekdays.className='cal-weekdays';
    weekdays.style.gridTemplateColumns = `64px repeat(${days.length},1fr)`;
    weekdays.innerHTML = `<div class="cal-day-header"></div>` + days.map(d=>{
      return `<div class="cal-day-header" aria-label="${fmtDate(d, {weekday:true})}">
        <div class="muted">${weekdaysShort[(d.getDay()+6)%7]}</div>
        <div>${d.getDate()}.${d.getMonth()+1}.</div>
      </div>`;
    }).join('');
    calendarEl.appendChild(weekdays);

    const wrap = document.createElement('div');
    wrap.className='time-grid';
    const timebar = document.createElement('div');
    timebar.className='timebar';
    for(let h=0;h<24;h++){
      const hour = document.createElement('div');
      hour.className='hour';
      hour.textContent = `${String(h).padStart(2,'0')}:00`;
      timebar.appendChild(hour);
    }
    wrap.appendChild(timebar);

    const daysContainer = document.createElement('div');
    daysContainer.className='days-container';
    daysContainer.style.setProperty('--cols', String(days.length));

    const rangeStart = addDays(days[0], 0);
    const rangeEnd = addDays(days[days.length-1], 0);

    const evs = eventsInRange(rangeStart, rangeEnd);

    days.forEach((d, idx)=>{
      const col = document.createElement('div');
      col.className='day-col';
      col.dataset.date = toISODate(d);
      enableDrop(col);
      for(let s=0;s<48;s++){
        const slot = document.createElement('div');
        slot.className='slot';
        col.appendChild(slot);
      }
      // place events
      const dayISO = toISODate(d);
      const dayEvents = evs.filter(e=>e.date===dayISO);
      dayEvents.forEach(e=>{
        const block = document.createElement('button');
        block.className='event-block';
        block.textContent = e.allDay ? e.title : `${e.start||''}-${e.end||''} ${e.title}`;
        block.style.top = e.allDay ? '4px' : timeToY(e.start)+'px';
        block.style.height = e.allDay ? '28px' : Math.max(24, durationToH(e.start, e.end))+'px';
        block.draggable = true;
        block.addEventListener('click', ()=> openEventModal(e));
        enableEventDrag(block, e);
        col.appendChild(block);
      });
      daysContainer.appendChild(col);
    });

    wrap.appendChild(daysContainer);
    calendarEl.appendChild(wrap);
  }

  function timeToY(t){
    if(!t) return 4;
    const [h,m] = t.split(':').map(Number);
    const minutes = h*60+m;
    return Math.floor(minutes/30)*24 + 4; // 48 rows * 24px
  }
  function durationToH(start, end){
    if(!start || !end) return 48;
    const [h1,m1] = start.split(':').map(Number);
    const [h2,m2] = end.split(':').map(Number);
    const dur = (h2*60+m2)-(h1*60+m1);
    return Math.max(24, Math.floor(dur/30)*24 - 4);
  }

  function eventsInRange(rangeStart, rangeEnd){
    const out = [];
    for(const ev of state.events){
      for(const occ of expandRecurrence(ev, rangeStart, rangeEnd)){
        out.push({...ev, date:occ});
      }
    }
    // performance: sort by start
    out.sort((a,b)=> (a.start||'99:99').localeCompare(b.start||'99:99'));
    return out;
  }

  function renderCalendar(){
    const cur = parseDate(state.cursor);
    if(state.view==='month') buildMonth();
    else if(state.view==='week'){
      const start = startOfWeek(cur);
      buildTimeGrid([0,1,2,3,4,5,6].map(n=>addDays(start,n)));
    }else{
      buildTimeGrid([cur]);
    }
  }

  /***********************
   * Drag & Drop
   ***********************/
  function enableDrop(el){
    el.addEventListener('dragover', e=>{ e.preventDefault(); el.classList.add('drop-target'); });
    el.addEventListener('dragleave', ()=> el.classList.remove('drop-target'));
    el.addEventListener('drop', e=>{
      e.preventDefault(); el.classList.remove('drop-target');
      const payload = e.dataTransfer.getData('text/plain');
      if(!payload) return;
      const data = JSON.parse(payload);
      const date = el.dataset.date || el.closest('[data-date]')?.dataset.date;
      if(!date) return;
      if(data.type==='event'){
        const ev = state.events.find(x=>x.id===data.id);
        if(!ev) return;
        ev.date = date;
        // adjust time if dropped into time grid: infer start/end by Y offset
        if(el.classList.contains('day-col')){
          const rect = el.getBoundingClientRect();
          const y = e.clientY - rect.top;
          const slots = Math.max(0, Math.min(47, Math.floor((y-4)/24)));
          const hh = String(Math.floor(slots/2)).padStart(2,'0');
          const mm = slots%2 ? '30' : '00';
          ev.start = `${hh}:${mm}`;
          // keep duration or default 60m
          const dur = ev.end && ev.start ? durationMinutes(ev.start, ev.end) : 60;
          const endMins = Math.min(23*60+59, Number(hh)*60+Number(mm)+dur);
          ev.end = `${String(Math.floor(endMins/60)).padStart(2,'0')}:${String(endMins%60).padStart(2,'0')}`;
          ev.allDay = false;
        }
        saveState();
      }else if(data.type==='task'){
        // create time block from task
        const t = state.tasks.find(x=>x.id===data.id);
        if(!t) return;
        const newEv = {
          id: uid(),
          title: t.title,
          date,
          start: '09:00',
          end: '10:00',
          allDay: false,
          location:'',
          desc: t.desc||'',
          rrule: t.rrule ? {...t.rrule}: null,
        };
        state.events.push(newEv);
        // link back? (optional)
        saveState();
      }
    });
  }
  function durationMinutes(a,b){
    if(!a||!b) return 60;
    const [h1,m1]=a.split(':').map(Number);
    const [h2,m2]=b.split(':').map(Number);
    return (h2*60+m2)-(h1*60+m1);
  }
  function enableEventDrag(el, ev){
    el.addEventListener('dragstart', (e)=>{
      e.dataTransfer.setData('text/plain', JSON.stringify({type:'event', id: ev.id}));
    });
  }

  /***********************
   * Tasks
   ***********************/
  const listsEl = document.getElementById('lists');
  const listsElSide = document.getElementById('lists-side');
  const taskListEl = document.getElementById('task-list');
  const taskListSideEl = document.getElementById('task-list-side');
  const taskSearchEl = document.getElementById('task-search');
  const taskSearchSideEl = document.getElementById('task-search-side');
  const filterEl = document.getElementById('task-filter');

  function renderLists(){
    const make = (container)=>{
      container.innerHTML='';
      state.lists.forEach(l=>{
        const chip = document.createElement('button');
        chip.className = 'chip' + (state.activeList===l.id?' active':'');
        chip.textContent = l.name;
        chip.setAttribute('role','tab');
        chip.addEventListener('click', ()=>{ state.activeList=l.id; renderTasks(); });
        container.appendChild(chip);
      });
    };
    if(!state.activeList) state.activeList = state.lists[0].id;
    make(listsEl);
    make(listsElSide);
  }

  function searchPredicate(t, q){
    if(!q) return true;
    q = q.toLowerCase();
    return (t.title||'').toLowerCase().includes(q) || (t.desc||'').toLowerCase().includes(q);
  }

  function filterPredicate(t, mode){
    const d = t.date ? parseDate(t.date) : null;
    const now = parseDate(todayISO());
    if(mode==='today') return d && sameDay(d, now);
    if(mode==='overdue') return d && d < now;
    if(mode==='scheduled') return !!t.date;
    if(mode==='repeat') return !!(t.rrule && t.rrule.freq);
    return true;
  }

  function renderTasks(){
    const q = (taskSearchEl.value || taskSearchSideEl.value || '').trim();
    const mode = filterEl.value || 'all';
    const listId = state.activeList || 'inbox';
    const tasks = state.tasks.filter(t=> (t.listId||'inbox')===listId)
      .filter(t=> searchPredicate(t,q) && filterPredicate(t,mode));
    const renderTo = (el)=>{
      el.innerHTML='';
      tasks.forEach(t=>{
        const card = document.createElement('div');
        card.className='task';
        card.draggable = true;
        card.addEventListener('dragstart', (e)=> e.dataTransfer.setData('text/plain', JSON.stringify({type:'task', id:t.id})));
        card.addEventListener('click', ()=> openTaskModal(t));
        const box = document.createElement('input'); box.type='checkbox'; box.checked=!!t.done;
        box.addEventListener('click', (e)=>{ e.stopPropagation(); t.done = !t.done; saveState(); });
        const col = document.createElement('div'); col.style.flex='1';
        const title = document.createElement('div'); title.className='task-title'; title.textContent = t.title;
        const meta = document.createElement('div'); meta.className='task-meta';
        const parts = [];
        if(t.date) parts.push(t.date);
        if(t.rrule?.freq) parts.push('↻ '+t.rrule.freq);
        meta.textContent = parts.join('  •  ');
        col.appendChild(title); col.appendChild(meta);
        if(t.subtasks?.length){
          const st = document.createElement('div'); st.className='subtasks';
          t.subtasks.forEach(s=>{
            const li = document.createElement('div'); li.textContent='• '+s.title; st.appendChild(li);
          });
          col.appendChild(st);
        }
        card.appendChild(box); card.appendChild(col);
        el.appendChild(card);
      });
    };
    renderTo(taskListEl);
    renderTo(taskListSideEl);
  }

  /***********************
   * Modals: Event
   ***********************/
  const eventModal = document.getElementById('event-modal');
  const eventForm = document.getElementById('event-form');
  const eventFields = {
    id: document.getElementById('event-id'),
    title: document.getElementById('event-title'),
    date: document.getElementById('event-date'),
    start: document.getElementById('event-start'),
    end: document.getElementById('event-end'),
    allDay: document.getElementById('event-allDay'),
    location: document.getElementById('event-location'),
    desc: document.getElementById('event-desc'),
    freq: document.getElementById('event-rrule-freq'),
    until: document.getElementById('event-rrule-until'),
  };
  document.getElementById('event-delete').addEventListener('click', ()=>{
    const id = eventFields.id.value;
    if(id){
      state.events = state.events.filter(e=>e.id!==id);
      saveState();
      eventModal.close();
    }else{
      eventModal.close();
    }
  });
  eventForm.addEventListener('close', ()=>{
    if(eventForm.returnValue==='save'){
      const id = eventFields.id.value || uid();
      const existing = state.events.find(e=>e.id===id);
      const ev = {
        id,
        title: eventFields.title.value.trim() || 'Ohne Titel',
        date: eventFields.date.value || todayISO(),
        start: clampTime(eventFields.start.value),
        end: clampTime(eventFields.end.value),
        allDay: eventFields.allDay.checked,
        location: eventFields.location.value.trim(),
        desc: eventFields.desc.value.trim(),
        rrule: eventFields.freq.value ? {freq:eventFields.freq.value, until: eventFields.until.value||null} : null,
      };
      if(ev.allDay){ ev.start=''; ev.end=''; }
      if(existing){
        Object.assign(existing, ev);
      }else{
        state.events.push(ev);
      }
      saveState();
    }
  });
  function openEventModal(ev){
    const e = ev || {id:'', title:'', date:state.cursor, start:'', end:'', allDay:false, location:'', desc:'', rrule:null};
    eventFields.id.value = e.id || '';
    eventFields.title.value = e.title || '';
    eventFields.date.value = e.date || todayISO();
    eventFields.start.value = e.start || '';
    eventFields.end.value = e.end || '';
    eventFields.allDay.checked = !!e.allDay;
    eventFields.location.value = e.location || '';
    eventFields.desc.value = e.desc || '';
    eventFields.freq.value = e.rrule?.freq || '';
    eventFields.until.value = e.rrule?.until || '';
    eventModal.showModal();
  }

  /***********************
   * Modals: Task
   ***********************/
  const taskModal = document.getElementById('task-modal');
  const taskForm = document.getElementById('task-form');
  const taskFields = {
    id: document.getElementById('task-id'),
    title: document.getElementById('task-title'),
    list: document.getElementById('task-list-name'),
    date: document.getElementById('task-date'),
    desc: document.getElementById('task-desc'),
    subtasks: document.getElementById('task-subtasks'),
    freq: document.getElementById('task-rrule-freq'),
    until: document.getElementById('task-rrule-until'),
  };
  document.getElementById('task-delete').addEventListener('click', ()=>{
    const id = taskFields.id.value;
    if(id){
      state.tasks = state.tasks.filter(t=>t.id!==id);
      saveState();
      taskModal.close();
    }else taskModal.close();
  });
  taskForm.addEventListener('close', ()=>{
    if(taskForm.returnValue==='save'){
      const id = taskFields.id.value || uid();
      let listName = taskFields.list.value.trim() || 'Inbox';
      let list = state.lists.find(l=>l.name.toLowerCase()===listName.toLowerCase());
      if(!list){ list = {id: uid(), name: listName}; state.lists.push(list); }
      const existing = state.tasks.find(t=>t.id===id);
      const subtasks = taskFields.subtasks.value.split('\n').map(s=>s.replace(/^-+\s*/,'').trim()).filter(Boolean).map(x=>({id:uid(), title:x, done:false}));
      const t = {
        id, title: taskFields.title.value.trim() || 'Neue Aufgabe',
        listId: list.id,
        date: taskFields.date.value || '',
        desc: taskFields.desc.value.trim(),
        subtasks,
        done: existing ? !!existing.done : false,
        rrule: taskFields.freq.value ? {freq:taskFields.freq.value, until: taskFields.until.value||null} : null,
      };
      if(existing) Object.assign(existing, t); else state.tasks.push(t);
      saveState();
    }
  });
  function openTaskModal(task){
    const t = task || {id:'', title:'', listId: state.activeList||'inbox', date:'', desc:'', subtasks:[], rrule:null};
    taskFields.id.value = t.id || '';
    taskFields.title.value = t.title || '';
    const list = state.lists.find(l=>l.id===t.listId) || state.lists[0];
    taskFields.list.value = list?.name || 'Inbox';
    taskFields.date.value = t.date || '';
    taskFields.desc.value = t.desc || '';
    taskFields.subtasks.value = (t.subtasks||[]).map(s=>s.title).join('\n');
    taskFields.freq.value = t.rrule?.freq || '';
    taskFields.until.value = t.rrule?.until || '';
    taskModal.showModal();
  }
  function fillDatalists(){
    const dl = document.getElementById('datalist-lists');
    dl.innerHTML='';
    state.lists.forEach(l=>{
      const o = document.createElement('option'); o.value=l.name; dl.appendChild(o);
    });
  }

  /***********************
   * Import / Export
   ***********************/
  document.getElementById('btn-export').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `calendarTodoApp_export_${todayISO()}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });
  document.getElementById('file-import').addEventListener('change', (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const imported = JSON.parse(reader.result);
        state = migrateState(imported);
        saveState();
      }catch(err){ alert('Import fehlgeschlagen: ungültige Datei.'); }
    };
    reader.readAsText(file);
    e.target.value='';
  });

  /***********************
   * Navigation & Controls
   ***********************/
  document.getElementById('btn-prev').addEventListener('click', ()=> moveCursor(-1));
  document.getElementById('btn-next').addEventListener('click', ()=> moveCursor(+1));
  document.getElementById('btn-today').addEventListener('click', ()=> { state.cursor = todayISO(); saveState(); });
  document.querySelectorAll('.view-switch [data-view]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      state.view = btn.dataset.view; saveState();
      document.querySelectorAll('.view-switch [data-view]').forEach(b=> b.setAttribute('aria-selected', String(b===btn)));
    });
  });
  function moveCursor(delta){
    const cur = parseDate(state.cursor);
    if(state.view==='month'){
      cur.setMonth(cur.getMonth()+delta);
    }else if(state.view==='week'){
      cur.setDate(cur.getDate()+7*delta);
    }else{
      cur.setDate(cur.getDate()+delta);
    }
    state.cursor = toISODate(cur); saveState();
  }

  document.getElementById('btn-new-event').addEventListener('click', ()=> openEventModal({date: state.cursor, allDay:false}));
  document.getElementById('btn-new-task').addEventListener('click', ()=> openTaskModal(null));
  document.getElementById('btn-add-task').addEventListener('click', ()=> openTaskModal(null));
  document.getElementById('btn-new-list').addEventListener('click', ()=>{
    const name = prompt('Name der Liste?')?.trim();
    if(!name) return;
    state.lists.push({id:uid(), name}); saveState();
  });

  document.getElementById('btn-notify').addEventListener('click', ensureNotifications);

  // search/filter bindings
  [taskSearchEl, taskSearchSideEl, filterEl].forEach(el=> el.addEventListener('input', ()=> renderTasks()));

  // Mobile tabs
  document.querySelectorAll('.tabs .tab').forEach(tab=>{
    tab.addEventListener('click', ()=>{
      document.querySelectorAll('.tabs .tab').forEach(t=> t.classList.remove('active'));
      tab.classList.add('active');
      const id = tab.dataset.tab;
      document.querySelectorAll('.mobile-pane').forEach(p=> p.classList.remove('active'));
      document.getElementById(id+'-pane').classList.add('active');
      document.getElementById('calendar-pane').style.display = id==='calendar' ? '' : 'none';
      document.getElementById('tasks-pane').style.display = id==='tasks' ? '' : 'none';
    });
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if(e.target.closest('input, textarea')) return; // ignore typing
    if(e.key.toLowerCase()==='n'){ openEventModal({date: state.cursor}); }
    if(e.key.toLowerCase()==='t'){ openTaskModal(null); }
    if(e.key.toLowerCase()==='d'){ state.cursor = todayISO(); saveState(); }
    if(e.key==='ArrowLeft'){ moveCursor(-1); }
    if(e.key==='ArrowRight'){ moveCursor(+1); }
  });

  // initial render
  render();

  </script>
</body>
</html>
