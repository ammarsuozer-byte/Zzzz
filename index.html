<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Minimal Kalender · Aufgaben & Termine</title>
<style>
  :root{
    --bg:#0f1115; --panel:#151922; --muted:#a9b0bd; --text:#e9edf4; --line:#232836;
    --acc:#8aa0ff; --ok:#7bd389; --warn:#e3b341; --danger:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }

  /* App shell */
  .app{display:grid; grid-template-rows:56px 48px 1fr 36px; height:100%}
  header, .toolbar, footer{display:flex; align-items:center; gap:8px; padding:0 16px}
  header{border-bottom:1px solid var(--line); background:var(--panel); justify-content:space-between}
  header .left, header .right{display:flex; align-items:center; gap:8px}
  .brand{font-weight:600; letter-spacing:.2px}
  .toolbar{border-bottom:1px solid var(--line); background:rgba(255,255,255,.02); gap:12px; flex-wrap:wrap}
  footer{border-top:1px solid var(--line); color:var(--muted); font-size:12px; justify-content:space-between}

  /* Controls */
  .btn{
    border:1px solid var(--line); background:transparent; color:var(--text);
    padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:500;
  }
  .btn:hover{border-color:#2b3142}
  .btn.acc{border-color:var(--acc); color:var(--acc)}
  .btn.danger{border-color:var(--danger); color:var(--danger)}
  .seg{display:inline-flex; border:1px solid var(--line); border-radius:10px; overflow:hidden}
  .seg button{border:0; background:transparent; color:var(--muted); padding:8px 12px; cursor:pointer}
  .seg button.active{background:var(--panel); color:var(--text)}
  .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px}
  .field-row{display:flex; gap:8px}
  input, select, textarea{
    background:#0b0e14; border:1px solid var(--line); color:var(--text);
    padding:8px 10px; border-radius:8px; width:100%;
  }
  label{font-size:12px; color:var(--muted)}
  .pill{border:1px solid var(--line); border-radius:999px; padding:4px 8px; font-size:12px; color:var(--muted)}

  /* Layout */
  .content{overflow:auto}
  .grid-month{display:grid; grid-template-columns:repeat(7,1fr); border-top:1px solid var(--line); border-left:1px solid var(--line)}
  .daycell{min-height:120px; border-right:1px solid var(--line); border-bottom:1px solid var(--line); padding:6px}
  .dow{display:grid; grid-template-columns:repeat(7,1fr); background:rgba(255,255,255,.03); border-bottom:1px solid var(--line)}
  .dow div{padding:8px 6px; color:var(--muted); font-size:12px}
  .datehead{display:flex; align-items:center; justify-content:space-between; color:var(--muted); font-size:12px}
  .badge{display:inline-block; font-size:11px; border:1px solid var(--line); border-radius:6px; padding:2px 6px; color:var(--muted)}
  .item{margin-top:6px; border-left:3px solid var(--acc); background:rgba(255,255,255,.02); padding:6px 8px; border-radius:6px}
  .item.task{border-left-color:var(--ok)}
  .item.past{opacity:.5}
  .item .t{font-size:13px; font-weight:600}
  .item .m{font-size:12px; color:var(--muted)}
  .flex{display:flex; gap:8px; align-items:center}
  .spacer{flex:1}

  /* Week view */
  .week{display:grid; grid-template-columns:60px repeat(7,1fr)}
  .wh{display:grid; grid-template-columns:60px repeat(7,1fr); background:rgba(255,255,255,.03); border-bottom:1px solid var(--line)}
  .wh div{padding:8px 6px; color:var(--muted); font-size:12px; border-right:1px solid var(--line)}
  .wh div:first-child{border-right:1px solid var(--line)}
  .col{border-right:1px solid var(--line)}
  .hour-row{display:grid; grid-template-columns:60px repeat(7,1fr)}
  .hour{height:56px; border-bottom:1px solid var(--line); color:var(--muted); font-size:12px; display:flex; align-items:flex-start; padding:6px}
  .slot{height:56px; border-bottom:1px solid var(--line); padding:4px}
  .block{position:relative; border-left:3px solid var(--acc); background:rgba(255,255,255,.03); padding:6px 8px; border-radius:6px; margin:4px 2px; font-size:12px}
  .block.task{border-left-color:var(--ok)}

  /* Day view */
  .day{display:grid; grid-template-columns:240px 1fr; gap:12px; padding:12px}
  .day .section{background:var(--panel); border:1px solid var(--line); border-radius:10px; padding:12px}
  .section h3{margin:0 0 8px 0; font-size:14px}

  /* List view */
  .listwrap{padding:12px}
  table{width:100%; border-collapse:collapse; border:1px solid var(--line)}
  th,td{border-bottom:1px solid var(--line); padding:10px; text-align:left; font-size:14px}
  th{background:rgba(255,255,255,.03); color:var(--muted)}
  tr:hover td{background:rgba(255,255,255,.02)}

  /* Dialog */
  dialog{border:1px solid var(--line); border-radius:12px; padding:16px; background:var(--panel); color:var(--text); width:min(720px,96vw)}
  dialog::backdrop{background:rgba(0,0,0,.45)}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .sublist{border:1px dashed var(--line); border-radius:8px; padding:8px; max-height:180px; overflow:auto}
  .subitem{display:flex; align-items:center; gap:8px; padding:4px 0}
  .kchip{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--line); border-radius:999px; margin:2px; font-size:12px}
  .kchip button{border:0; background:transparent; color:var(--muted); cursor:pointer}

  /* Responsive for iPad & down */
  @media (max-width: 1024px){
    .day{grid-template-columns:1fr}
    .grid2{grid-template-columns:1fr}
    .dow div{font-size:11px}
    .hour{height:48px}
    .slot{height:48px}
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="left">
      <span class="brand">Kalender</span>
      <span class="pill" id="todayLabel"></span>
    </div>
    <div class="right">
      <button class="btn" id="prevBtn">◀</button>
      <button class="btn" id="todayBtn">Heute</button>
      <button class="btn" id="nextBtn">▶</button>
      <div class="seg" id="viewSeg">
        <button data-view="day" class="active">Tag</button>
        <button data-view="week">Woche</button>
        <button data-view="month">Monat</button>
        <button data-view="list">Liste</button>
      </div>
      <div class="spacer"></div>
      <button class="btn" id="addItemBtn">Neu</button>
      <button class="btn" id="templatesBtn">Templates</button>
      <button class="btn" id="exportBtn">Export</button>
      <input type="file" id="importFile" style="display:none" accept="application/json" />
      <button class="btn" id="importBtn">Import</button>
    </div>
  </header>

  <div class="toolbar">
    <div class="field-row" style="align-items:center">
      <label class="pill">Kategorie:</label>
      <select id="categoryFilter"><option value="">Alle</option></select>
      <button class="btn" id="manageCatsBtn">Kategorien</button>
    </div>
    <div class="field-row" style="align-items:center">
      <label class="pill">Sortierung (Liste):</label>
      <select id="listSort">
        <option value="deadline">Deadline</option>
        <option value="category">Kategorie</option>
        <option value="type">Typ</option>
        <option value="title">Titel</option>
      </select>
    </div>
    <div class="spacer"></div>
    <span class="pill" id="countsPill"></span>
  </div>

  <div class="content" id="content"></div>

  <footer>
    <span>Minimal Dark • Lokaler Speicher</span>
    <span id="status" style="color:var(--muted)"></span>
  </footer>
</div>

<!-- Create/Edit Item Dialog -->
<dialog id="itemDlg">
  <form id="itemForm" method="dialog">
    <h3 id="dlgTitle">Eintrag</h3>
    <div class="grid2">
      <div>
        <div class="field">
          <label>Titel</label>
          <input id="f_title" required />
        </div>
        <div class="field">
          <label>Typ</label>
          <select id="f_type">
            <option value="task">Aufgabe</option>
            <option value="event">Termin</option>
          </select>
        </div>
        <div class="field-row">
          <div class="field">
            <label>Start-Datum</label>
            <input type="date" id="f_startDate" />
          </div>
          <div class="field">
            <label>Start-Zeit</label>
            <input type="time" id="f_startTime" />
          </div>
        </div>
        <div class="field-row">
          <div class="field">
            <label>End-Datum</label>
            <input type="date" id="f_endDate" />
          </div>
          <div class="field">
            <label>End-Zeit</label>
            <input type="time" id="f_endTime" />
          </div>
        </div>
        <div class="field-row">
          <div class="field">
            <label>Ganztägig</label>
            <select id="f_allDay"><option value="no">Nein</option><option value="yes">Ja</option></select>
          </div>
          <div class="field">
            <label>Kategorie</label>
            <select id="f_category"></select>
          </div>
        </div>
        <div class="field">
          <label>Notiz</label>
          <textarea id="f_notes" rows="3" placeholder="Optional"></textarea>
        </div>
      </div>
      <div>
        <div class="field">
          <label>Unteraufgaben / Checkliste</label>
          <div class="sublist" id="sublist"></div>
          <div class="field-row">
            <input id="subInput" placeholder="Unteraufgabe hinzufügen" />
            <button class="btn" id="addSubBtn" type="button">+ Hinzufügen</button>
          </div>
        </div>

        <div class="field">
          <label>Wiederholung (nur Aufgaben, wöchentlich)</label>
          <div class="field-row">
            <label class="pill"><input type="checkbox" id="f_recur" /> aktiv</label>
            <div id="weekdayBox" class="field-row" style="flex-wrap:wrap"></div>
          </div>
        </div>

        <div class="field-row">
          <button class="btn acc" id="saveItemBtn" type="submit">Speichern</button>
          <button class="btn danger" id="deleteItemBtn" type="button">Löschen</button>
          <div class="spacer"></div>
          <button class="btn" value="cancel">Abbrechen</button>
        </div>
      </div>
    </div>
  </form>
</dialog>

<!-- Categories Dialog -->
<dialog id="catDlg">
  <form id="catForm" method="dialog">
    <h3>Kategorien</h3>
    <div id="catList" class="sublist"></div>
    <div class="field-row" style="margin-top:8px">
      <input id="catInput" placeholder="Neue Kategorie" />
      <button class="btn" id="addCatBtn" type="button">+ Hinzufügen</button>
      <div class="spacer"></div>
      <button class="btn" value="close">Schließen</button>
    </div>
  </form>
</dialog>

<!-- Templates Dialog -->
<dialog id="tplDlg">
  <form method="dialog">
    <h3>Templates</h3>
    <div id="tplList" class="sublist"></div>
    <div class="grid2">
      <div>
        <div class="field">
          <label>Titel</label>
          <input id="tplTitle" />
        </div>
        <div class="field">
          <label>Elemente (eine pro Zeile; Prefix: task: / event:)</label>
          <textarea id="tplItems" rows="6" placeholder="task: Recherche&#10;task: Entwurf&#10;event: Kickoff-Meeting"></textarea>
        </div>
        <div class="field-row">
          <button class="btn acc" id="saveTplBtn" type="button">Template speichern</button>
          <div class="spacer"></div>
          <button class="btn" value="close">Schließen</button>
        </div>
      </div>
      <div>
        <div class="field">
          <label>Template anwenden (Start-Datum wählen)</label>
          <input type="date" id="tplDate" />
        </div>
        <div class="field-row">
          <button class="btn" id="applyTplBtn" type="button">Template anwenden</button>
        </div>
        <p style="color:var(--muted); font-size:12px">Aufgaben werden ohne Zeiten angelegt; Termine 09:00–10:00.</p>
      </div>
    </div>
  </form>
</dialog>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const state = {
    view: 'day',
    cursor: new Date(),
    items: [],       // array of {id,type,title,notes,allDay,categoryId,done,subtasks:[{id,title,done}],start,end,recurrence:{weekdays:[0..6]}}
    categories: [],  // array of {id,name}
    templates: []    // array of {id,title,lines:[ {type:'task'|'event', title} ]}
  };

  const STORAGE_KEY = 'minimal-cal-app-v1';

  function uid(){ return Math.random().toString(36).slice(2,10); }
  function fmtDate(d){ return d.toISOString().slice(0,10); }
  function fmtTime(d){ return d.toTimeString().slice(0,5); }
  function toDate(dateStr, timeStr){ if(!dateStr) return null; if(!timeStr) return new Date(dateStr+'T00:00:00'); return new Date(dateStr+'T'+timeStr); }
  function clone(obj){ return JSON.parse(JSON.stringify(obj)); }
  function startOfWeek(d){
    const dt = new Date(d); const wd = (dt.getDay()+6)%7; // Mon=0
    dt.setDate(dt.getDate()-wd); dt.setHours(0,0,0,0); return dt;
  }
  function endOfWeek(d){ const s = startOfWeek(d); const e = new Date(s); e.setDate(e.getDate()+7); return e; }
  function startOfMonth(d){ const x = new Date(d.getFullYear(), d.getMonth(), 1); x.setHours(0,0,0,0); return x; }
  function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 1); }
  function sameDay(a,b){ return a.getFullYear()==b.getFullYear() && a.getMonth()==b.getMonth() && a.getDate()==b.getDate(); }
  function between(dt, a, b){ return dt>=a && dt<b; }
  function parseDateTime(s){ return s? new Date(s): null; }

  // Storage
  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      items: state.items, categories: state.categories, templates: state.templates
    }));
    $('#status').textContent = 'Gespeichert';
    setTimeout(()=>{$('#status').textContent='';}, 1000);
  }
  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      try{
        const obj = JSON.parse(raw);
        state.items = obj.items||[];
        state.categories = obj.categories||[];
        state.templates = obj.templates||[];
      }catch(e){ console.warn(e); }
    }
    if(state.categories.length===0){
      state.categories = [
        {id: uid(), name:'Allgemein'},
        {id: uid(), name:'Arbeit'},
        {id: uid(), name:'Privat'}
      ];
    }
    refreshCategoryControls();
  }

  // Occurrences for recurring tasks (weekly)
  function occurrences(item, rangeStart, rangeEnd){
    const arr = [];
    const s = parseDateTime(item.start)||parseDateTime(item.end);
    if(!s) return arr;
    if(item.recurrence && item.recurrence.weekdays?.length){
      // generate each day in range
      const d = new Date(rangeStart);
      while(d < rangeEnd){
        const wd = (d.getDay()+6)%7; // Mon=0
        if(item.recurrence.weekdays.includes(wd)){
          const st = new Date(d); const en = new Date(d);
          // if original had time, keep it
          if(item.start){
            const t = new Date(item.start);
            st.setHours(t.getHours(), t.getMinutes(), 0, 0);
          }
          if(item.end){
            const t2 = new Date(item.end);
            en.setHours(t2.getHours(), t2.getMinutes(), 0, 0);
          }
          arr.push({...item, _occ:true, _start:st, _end: en});
        }
        d.setDate(d.getDate()+1);
      }
    } else {
      const st = parseDateTime(item.start); const en = parseDateTime(item.end)||st;
      if(!st){ return arr; }
      if(en >= rangeStart && st < rangeEnd){ arr.push({...item, _start:st, _end:en}); }
    }
    return arr;
  }

  function getFilteredItems(){
    const cat = $('#categoryFilter').value;
    return state.items.filter(it => !cat || it.categoryId===cat);
  }

  // Counts
  function updateCounts(){
    const items = getFilteredItems();
    const tasks = items.filter(i=>i.type==='task');
    const events = items.filter(i=>i.type==='event');
    const done = items.filter(i=>i.done).length;
    $('#countsPill').textContent = `Aufgaben: ${tasks.length} • Termine: ${events.length} • Erledigt: ${done}`;
  }

  // Views
  function render(){
    $('#todayLabel').textContent = new Intl.DateTimeFormat('de-DE',{dateStyle:'full'}).format(new Date());
    updateCounts();
    const v = state.view;
    if(v==='month') renderMonth(); else if(v==='week') renderWeek(); else if(v==='day') renderDay(); else renderList();
  }

  function renderMonth(){
    const root = $('#content'); root.innerHTML = '';
    const s = startOfMonth(state.cursor), e = endOfMonth(state.cursor);
    const sGrid = startOfWeek(s); const eGrid = endOfWeek(e);
    const dow = ['Mo','Di','Mi','Do','Fr','Sa','So'];
    const dowEl = document.createElement('div'); dowEl.className='dow';
    dow.forEach(d=>{ const x=document.createElement('div'); x.textContent=d; dowEl.appendChild(x); });
    root.appendChild(dowEl);

    const grid = document.createElement('div'); grid.className='grid-month';
    const items = getFilteredItems();
    let d = new Date(sGrid);
    while(d<eGrid){
      const cell = document.createElement('div'); cell.className='daycell';
      const inMonth = d.getMonth()===state.cursor.getMonth();
      const datehead = document.createElement('div'); datehead.className='datehead';
      const dayNum = document.createElement('div'); dayNum.textContent = d.getDate();
      if(!inMonth) dayNum.style.opacity = .4;
      const plus = document.createElement('button'); plus.className='btn'; plus.textContent='+'; plus.title='Neu an diesem Tag'; plus.onclick = ()=> openNewAtDate(d);
      datehead.append(dayNum, plus);
      cell.appendChild(datehead);

      // items of the day
      const dayStart = new Date(d); const dayEnd = new Date(d); dayEnd.setDate(dayEnd.getDate()+1);
      items.forEach(it=>{
        const occs = occurrences(it, dayStart, dayEnd);
        occs.forEach(oc=>{
          const el = document.createElement('div'); el.className='item '+it.type+(oc._end < new Date() ? ' past':'');
          const timeTxt = it.allDay==='yes' ? 'Ganztägig' :
            (oc._start ? fmtTime(oc._start):'') + (oc._end? '–'+fmtTime(oc._end):'');
          el.innerHTML = `
            <div class="flex">
              <input type="checkbox" ${it.done?'checked':''} data-id="${it.id}" class="chk">
              <div class="t">${it.title}</div>
              <span class="spacer"></span>
              <span class="badge">${it.type==='task'?'Aufgabe':'Termin'}</span>
            </div>
            <div class="m">${timeTxt || ''}</div>
          `;
          el.querySelector('.chk').addEventListener('change', (ev)=> toggleDone(it.id, ev.target.checked));
          el.onclick = (ev)=>{ if(ev.target.classList.contains('chk')) return; openEdit(it.id); };
          cell.appendChild(el);
        });
      });

      grid.appendChild(cell);
      d.setDate(d.getDate()+1);
    }
    root.appendChild(grid);
  }

  function renderWeek(){
    const root = $('#content'); root.innerHTML = '';
    const s = startOfWeek(state.cursor), e = endOfWeek(state.cursor);
    const days = []; let d = new Date(s); while(d<e){ days.push(new Date(d)); d.setDate(d.getDate()+1); }
    const head = document.createElement('div'); head.className='wh';
    head.appendChild(Object.assign(document.createElement('div'),{textContent:''}));
    days.forEach(di=>{
      const x=document.createElement('div'); x.textContent = new Intl.DateTimeFormat('de-DE',{weekday:'short',day:'2-digit',month:'2-digit'}).format(di);
      head.appendChild(x);
    });
    root.appendChild(head);

    const wrap = document.createElement('div'); wrap.className='week';
    const hours = Array.from({length:24},(_,i)=>i);
    hours.forEach(h=>{
      const row = document.createElement('div'); row.className='hour-row';
      const lab = document.createElement('div'); lab.className='hour'; lab.textContent = h.toString().padStart(2,'0')+':00';
      row.appendChild(lab);
      days.forEach(di=>{
        const slot = document.createElement('div'); slot.className='slot';
        slot.addEventListener('dblclick', ()=> openNewAtDateTime(di, h));
        // place blocks that start this hour
        getFilteredItems().forEach(it=>{
          const occs = occurrences(it, new Date(di), new Date(di.getFullYear(), di.getMonth(), di.getDate()+1));
          occs.forEach(oc=>{
            if(oc._start && oc._start.getHours()===h){
              const b = document.createElement('div'); b.className='block '+it.type+(oc._end < new Date() ? ' past':'');
              b.innerHTML = `
                <div class="flex">
                  <input type="checkbox" ${it.done?'checked':''} data-id="${it.id}" class="chk">
                  <div class="t">${it.title}</div>
                  <span class="spacer"></span>
                  <span class="badge">${it.allDay==='yes' ? 'Ganztägig' : fmtTime(oc._start)+'–'+(oc._end?fmtTime(oc._end):'')}</span>
                </div>`;
              b.querySelector('.chk').addEventListener('change', (ev)=> toggleDone(it.id, ev.target.checked));
              b.onclick = (ev)=>{ if(ev.target.classList.contains('chk')) return; openEdit(it.id); };
              slot.appendChild(b);
            }
          });
        });
        row.appendChild(slot);
      });
      wrap.appendChild(row);
    });
    root.appendChild(wrap);
  }

  function renderDay(){
    const root = $('#content'); root.innerHTML = '';
    const today = new Date(state.cursor); today.setHours(0,0,0,0);
    const dayStart = new Date(today), dayEnd = new Date(today); dayEnd.setDate(dayEnd.getDate()+1);

    const wrap = document.createElement('div'); wrap.className='day';

    const left = document.createElement('div'); left.className='section';
    left.innerHTML = `<h3>${new Intl.DateTimeFormat('de-DE',{weekday:'long', day:'2-digit', month:'2-digit', year:'numeric'}).format(today)}</h3>`;
    const todayList = document.createElement('div');
    getFilteredItems().forEach(it=>{
      occurrences(it, dayStart, dayEnd).forEach(oc=>{
        const el = document.createElement('div'); el.className='item '+it.type+(oc._end < new Date() ? ' past':'');
        el.innerHTML = `
          <div class="flex">
            <input type="checkbox" ${it.done?'checked':''} data-id="${it.id}" class="chk">
            <div class="t">${it.title}</div>
            <span class="spacer"></span>
            <span class="badge">${it.type==='task'?'Aufgabe':'Termin'}</span>
          </div>
          <div class="m">${it.allDay==='yes' ? 'Ganztägig' : (oc._start?fmtTime(oc._start):'')+(oc._end?'–'+fmtTime(oc._end):'')}</div>
        `;
        el.querySelector('.chk').addEventListener('change', (ev)=> toggleDone(it.id, ev.target.checked));
        el.onclick = (ev)=>{ if(ev.target.classList.contains('chk')) return; openEdit(it.id); };
        todayList.appendChild(el);
      });
    });
    left.appendChild(todayList);

    const right = document.createElement('div'); right.className='section';
    right.innerHTML = `<h3>Schnell hinzufügen</h3>`;
    const quick = document.createElement('div');
    quick.innerHTML = `
      <div class="field-row">
        <input id="quickTitle" placeholder="Titel" />
        <select id="quickType"><option value="task">Aufgabe</option><option value="event">Termin</option></select>
        <button class="btn acc" id="quickAdd">+ Hinzufügen</button>
      </div>`;
    right.appendChild(quick);

    wrap.append(left,right);
    root.appendChild(wrap);

    $('#quickAdd').onclick = ()=>{
      const t = $('#quickTitle').value.trim();
      if(!t) return;
      const typ = $('#quickType').value;
      const day = new Date(state.cursor);
      const id = uid();
      state.items.push({
        id, type:typ, title:t, notes:'', allDay:'yes',
        categoryId: state.categories[0]?.id || '',
        done:false, subtasks:[],
        start:new Date(day.getFullYear(),day.getMonth(),day.getDate(), typ==='event'?9:0).toISOString(),
        end:new Date(day.getFullYear(),day.getMonth(),day.getDate(), typ==='event'?10:0).toISOString()
      });
      save(); render();
    };
  }

  function renderList(){
    const root = $('#content'); root.innerHTML = '';
    const wrap = document.createElement('div'); wrap.className='listwrap';
    const tbl = document.createElement('table');
    tbl.innerHTML = `<thead><tr>
      <th>Typ</th><th>Titel</th><th>Kategorie</th><th>Start</th><th>Ende</th><th>Status</th>
    </tr></thead><tbody></tbody>`;
    const tbody = tbl.querySelector('tbody');

    const arr = getFilteredItems().slice();
    const sort = $('#listSort').value;
    arr.sort((a,b)=>{
      if(sort==='deadline'){
        const ad = a.end||a.start||''; const bd = b.end||b.start||'';
        return ad.localeCompare(bd);
      } else if(sort==='category'){
        return (catName(a.categoryId)).localeCompare(catName(b.categoryId));
      } else if(sort==='type'){
        return a.type.localeCompare(b.type);
      } else {
        return a.title.localeCompare(b.title);
      }
    });

    arr.forEach(it=>{
      const tr = document.createElement('tr');
      const s = parseDateTime(it.start), e = parseDateTime(it.end);
      tr.innerHTML = `
        <td>${it.type==='task'?'Aufgabe':'Termin'}</td>
        <td><a href="#" class="edit" data-id="${it.id}">${it.title}</a></td>
        <td>${catName(it.categoryId)}</td>
        <td>${s? (fmtDate(s)+' '+(it.allDay==='yes'?'':fmtTime(s))):''}</td>
        <td>${e? (fmtDate(e)+' '+(it.allDay==='yes'?'':fmtTime(e))):''}</td>
        <td><input type="checkbox" class="chk" data-id="${it.id}" ${it.done?'checked':''}></td>
      `;
      tr.querySelector('.chk').addEventListener('change',(ev)=> toggleDone(it.id, ev.target.checked));
      tr.querySelector('.edit').addEventListener('click', (ev)=>{ ev.preventDefault(); openEdit(it.id); });
      tbody.appendChild(tr);
    });

    wrap.appendChild(tbl);
    root.appendChild(wrap);
  }

  // Category helpers
  function catName(id){ return state.categories.find(c=>c.id===id)?.name || ''; }
  function refreshCategoryControls(){
    const sel = $('#f_category');
    sel.innerHTML = state.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    const filter = $('#categoryFilter');
    const cur = filter.value;
    filter.innerHTML = `<option value="">Alle</option>` + state.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
    filter.value = cur;
  }

  // Item CRUD
  function openNewAtDate(date){
    const dt = new Date(date);
    openItemDialog({ id: uid(), type:'task', title:'', notes:'', allDay:'yes',
      categoryId: state.categories[0]?.id || '', done:false, subtasks:[],
      start: new Date(dt.getFullYear(),dt.getMonth(),dt.getDate(),9).toISOString(),
      end:   new Date(dt.getFullYear(),dt.getMonth(),dt.getDate(),10).toISOString()
    }, true);
  }
  function openNewAtDateTime(date, hour){
    const d = new Date(date);
    openItemDialog({ id: uid(), type:'event', title:'', notes:'', allDay:'no',
      categoryId: state.categories[0]?.id || '', done:false, subtasks:[],
      start: new Date(d.getFullYear(),d.getMonth(),d.getDate(),hour).toISOString(),
      end:   new Date(d.getFullYear(),d.getMonth(),d.getDate(),hour+1).toISOString()
    }, true);
  }
  function openEdit(id){
    const it = state.items.find(i=>i.id===id);
    if(it) openItemDialog(clone(it), false);
  }

  function openItemDialog(model, isNew){
    const dlg = $('#itemDlg');
    $('#dlgTitle').textContent = isNew? 'Neu anlegen' : 'Bearbeiten';
    $('#deleteItemBtn').style.display = isNew? 'none':'inline-flex';

    $('#f_title').value = model.title || '';
    $('#f_type').value = model.type || 'task';
    const st = parseDateTime(model.start), en = parseDateTime(model.end);
    $('#f_startDate').value = st? fmtDate(st):'';
    $('#f_startTime').value = st && model.allDay!=='yes'? fmtTime(st):'';
    $('#f_endDate').value = en? fmtDate(en):'';
    $('#f_endTime').value = en && model.allDay!=='yes'? fmtTime(en):'';
    $('#f_allDay').value = model.allDay || 'no';
    $('#f_category').value = model.categoryId || '';
    $('#f_notes').value = model.notes || '';

    // subtasks / checklist
    const subWrap = $('#sublist'); subWrap.innerHTML='';
    (model.subtasks||[]).forEach(su => addSubEl(subWrap, su));

    $('#addSubBtn').onclick = ()=>{
      const t = $('#subInput').value.trim(); if(!t) return;
      const su = {id:uid(), title:t, done:false};
      model.subtasks = model.subtasks||[]; model.subtasks.push(su);
      addSubEl(subWrap, su);
      $('#subInput').value='';
    };

    // recurrence
    const wdNames = ['Mo','Di','Mi','Do','Fr','Sa','So'];
    const wbox = $('#weekdayBox'); wbox.innerHTML = '';
    const rec = model.recurrence || {weekdays:[]};
    wdNames.forEach((n,idx)=>{
      const lab = document.createElement('label'); lab.className='kchip';
      const cb = document.createElement('input'); cb.type='checkbox';
      cb.checked = rec.weekdays.includes(idx);
      cb.onchange = ()=> {
        if(cb.checked){ if(!rec.weekdays.includes(idx)) rec.weekdays.push(idx); }
        else { rec.weekdays = rec.weekdays.filter(x=>x!==idx); }
      };
      lab.append(cb, document.createTextNode(n));
      wbox.appendChild(lab);
    });
    $('#f_recur').checked = (model.type==='task') && (rec.weekdays?.length>0);
    $('#f_recur').onchange = (e)=>{
      if(!e.target.checked) rec.weekdays = [];
    };

    // listeners
    $('#f_allDay').onchange = ()=>{
      const allday = $('#f_allDay').value==='yes';
      $('#f_startTime').disabled = allday; $('#f_endTime').disabled = allday;
      if(allday){ $('#f_startTime').value=''; $('#f_endTime').value=''; }
    };
    $('#f_allDay').dispatchEvent(new Event('change'));

    $('#saveItemBtn').onclick = (ev)=>{
      ev.preventDefault();
      // collect
      model.title = $('#f_title').value.trim();
      model.type = $('#f_type').value;
      model.allDay = $('#f_allDay').value;
      model.categoryId = $('#f_category').value;
      model.notes = $('#f_notes').value;
      // datetimes
      const sd = $('#f_startDate').value, stime = $('#f_startTime').value;
      const ed = $('#f_endDate').value, etime = $('#f_endTime').value;
      const sdt = sd? toDate(sd, model.allDay==='yes'? null : stime): null;
      const edt = ed? toDate(ed, model.allDay==='yes'? null : etime): null;
      model.start = sdt? sdt.toISOString() : null;
      model.end = edt? edt.toISOString() : null;

      // recurrence
      if(model.type==='task' && $('#f_recur').checked && model.recurrence){
        model.recurrence.weekdays = model.recurrence.weekdays?.sort() || [];
      } else {
        model.recurrence = {weekdays:[]};
      }

      if(isNew){ state.items.push(model); } else {
        const idx = state.items.findIndex(i=>i.id===model.id);
        if(idx>=0) state.items[idx]=model;
      }
      save(); dlg.close(); render();
    };

    $('#deleteItemBtn').onclick = ()=>{
      state.items = state.items.filter(i=>i.id!==model.id);
      save(); dlg.close(); render();
    };

    dlg.returnValue = '';
    dlg.showModal();
  }

  function addSubEl(container, su){
    const line = document.createElement('div'); line.className='subitem';
    line.innerHTML = `
      <input type="checkbox" ${su.done?'checked':''} class="s-chk">
      <input value="${su.title.replace(/"/g,'&quot;')}" class="s-title" />
      <button class="btn" type="button">✕</button>
    `;
    const [chk, title, del] = line.querySelectorAll('input,button');
    chk.onchange = ()=>{ su.done = chk.checked; };
    title.oninput = ()=>{ su.title = title.value; };
    del.onclick = ()=>{ container.removeChild(line); };
    container.appendChild(line);
  }

  function toggleDone(id, val){
    const it = state.items.find(i=>i.id===id);
    if(it){ it.done = !!val; save(); render(); }
  }

  // Categories dialog
  $('#manageCatsBtn').onclick = ()=>{
    const dlg = $('#catDlg'); const list = $('#catList'); list.innerHTML='';
    state.categories.forEach(cat=>{
      const row = document.createElement('div'); row.className='subitem';
      row.innerHTML = `<input value="${cat.name}" /><button class="btn danger" type="button">Löschen</button>`;
      const [inp,del] = row.querySelectorAll('input,button');
      inp.oninput = ()=>{ cat.name = inp.value; refreshCategoryControls(); save(); render(); };
      del.onclick = ()=>{
        // reassign items to first category
        const first = state.categories.find(c=>c.id!==cat.id);
        state.items.forEach(i=>{ if(i.categoryId===cat.id) i.categoryId = first?.id || ''; });
        state.categories = state.categories.filter(c=>c.id!==cat.id);
        refreshCategoryControls(); save(); $('#manageCatsBtn').click();
      };
      list.appendChild(row);
    });
    $('#addCatBtn').onclick = ()=>{
      const name = $('#catInput').value.trim(); if(!name) return;
      state.categories.push({id:uid(), name}); $('#catInput').value='';
      refreshCategoryControls(); save(); $('#manageCatsBtn').click();
    };
    dlg.showModal();
  };

  // Templates dialog
  $('#templatesBtn').onclick = ()=>{
    const dlg = $('#tplDlg'); const list = $('#tplList'); list.innerHTML='';
    state.templates.forEach(tp=>{
      const row = document.createElement('div'); row.className='subitem';
      row.innerHTML = `<span style="flex:1">${tp.title}</span>
        <button class="btn" data-act="use" data-id="${tp.id}">Anwenden</button>
        <button class="btn danger" data-act="del" data-id="${tp.id}">Löschen</button>`;
      list.appendChild(row);
    });
    list.onclick = (ev)=>{
      const id = ev.target.getAttribute('data-id'); const act = ev.target.getAttribute('data-act');
      if(!id) return;
      if(act==='del'){ state.templates = state.templates.filter(t=>t.id!==id); save(); $('#templatesBtn').click(); }
      if(act==='use'){ // load into right side for applying
        const tp = state.templates.find(t=>t.id===id);
        $('#tplTitle').value = tp.title; $('#tplItems').value = tp.lines.map(l=>`${l.type}: ${l.title}`).join('\n');
      }
    };
    $('#saveTplBtn').onclick = ()=>{
      const title = $('#tplTitle').value.trim(); if(!title) return;
      const lines = $('#tplItems').value.split('\n').map(s=>s.trim()).filter(Boolean).map(s=>{
        const m = s.match(/^(task|event)\s*:\s*(.+)$/i);
        return m? {type:m[1].toLowerCase(), title:m[2]} : {type:'task', title:s};
      });
      const existing = state.templates.find(t=>t.title.toLowerCase()===title.toLowerCase());
      const obj = {id: existing?.id || uid(), title, lines};
      if(existing){ Object.assign(existing, obj); } else { state.templates.push(obj); }
      save(); $('#templatesBtn').click();
    };
    $('#applyTplBtn').onclick = ()=>{
      const dateStr = $('#tplDate').value; if(!dateStr) return;
      const base = new Date(dateStr+'T00:00:00');
      const lines = $('#tplItems').value.split('\n').map(s=>s.trim()).filter(Boolean).map(s=>{
        const m = s.match(/^(task|event)\s*:\s*(.+)$/i);
        return m? {type:m[1].toLowerCase(), title:m[2]} : {type:'task', title:s};
      });
      lines.forEach((ln,i)=>{
        const st = new Date(base); st.setDate(st.getDate()+i);
        const en = new Date(st);
        let type = ln.type==='event'?'event':'task';
        if(type==='event'){ st.setHours(9,0,0,0); en.setHours(10,0,0,0); }
        const item = {
          id: uid(), type, title: ln.title, notes:'', allDay: type==='task'?'yes':'no',
          categoryId: state.categories[0]?.id || '', done:false, subtasks:[],
          start: st.toISOString(), end: en.toISOString(), recurrence:{weekdays:[]}
        };
        state.items.push(item);
      });
      save(); render();
    };
    dlg.showModal();
  };

  // Export / Import
  $('#exportBtn').onclick = ()=>{
    const data = JSON.stringify({items:state.items, categories:state.categories, templates:state.templates}, null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'kalender-export.json'; a.click();
  };
  $('#importBtn').onclick = ()=> $('#importFile').click();
  $('#importFile').onchange = (ev)=>{
    const file = ev.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const obj = JSON.parse(reader.result);
        state.items = obj.items||[]; state.categories = obj.categories||[]; state.templates = obj.templates||[];
        refreshCategoryControls(); save(); render();
      }catch(e){ alert('Import fehlgeschlagen: '+e.message); }
    };
    reader.readAsText(file);
  };

  // Header buttons / view switch
  $('#todayBtn').onclick = ()=>{ state.cursor = new Date(); render(); };
  $('#prevBtn').onclick = ()=>{ if(state.view==='day') state.cursor.setDate(state.cursor.getDate()-1);
                                else if(state.view==='week') state.cursor.setDate(state.cursor.getDate()-7);
                                else if(state.view==='month') state.cursor.setMonth(state.cursor.getMonth()-1);
                                else state.cursor.setDate(state.cursor.getDate()-7);
                                render(); };
  $('#nextBtn').onclick = ()=>{ if(state.view==='day') state.cursor.setDate(state.cursor.getDate()+1);
                                else if(state.view==='week') state.cursor.setDate(state.cursor.getDate()+7);
                                else if(state.view==='month') state.cursor.setMonth(state.cursor.getMonth()+1);
                                else state.cursor.setDate(state.cursor.getDate()+7);
                                render(); };

  $('#viewSeg').onclick = (ev)=>{
    if(ev.target.tagName!=='BUTTON') return;
    $$('#viewSeg button').forEach(b=>b.classList.remove('active'));
    ev.target.classList.add('active');
    state.view = ev.target.getAttribute('data-view'); render();
  };

  // New item
  $('#addItemBtn').onclick = ()=> openNewAtDate(state.cursor);

  // Filters
  $('#categoryFilter').onchange = ()=> render();
  $('#listSort').onchange = ()=> render();

  // Init
  load();
  render();

})();
</script>
</body>
</html>
